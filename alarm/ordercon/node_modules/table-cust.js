var $ = require('jquery')

var tbody =
	'<table class="table table-striped table-bordered table-hover dataTable" id="cust-table" >' +
		'<thead>' +
			'<tr>' +
				'<th style="width:3%;">序号</th>' +
				'<th style="width:9%;">零售户名称</th>' +
				'<th style="width:4%;">许可证号</th>' +
				'<th style="width:8%;">经营地址</th>' +
				'<th style="width:4%;">联系电话</th>' +
				'<th style="width:3%;">订购量</th>' +
				'<th style="width:3%;">特殊<br>客户</th>' +
				/*'<th style="width:3%;">操作</th>' +*/
			'</tr>' +
		'</thead>' +
		'<tbody></tbody>' +
	'</table>'

var columnDefs = [
		{
			className:'digit-center',
			searchable: false,
			orderable: false,
			targets: 0
		}, {
			// 零售户名称
			className:'digit-center',
			data: 'CUST_NAME',
			targets: 1
		}, {
			// 许可证号
			className:'digit-center',
			data: 'NATION_CUST_CODE',
			targets: 2,
		}, {
			// 经营地址
			data: 'BUSI_ADDR',
			targets: 3
		},{
			// 联系电话
			data: 'ORDER_TEL',
			targets: 4
		}, {
			// 订购量
			className:'digit-center',
			data: 'QTY_SOLD',
			render: function(data, type, full, meta) {
				return '<span custid="' + full.CUST_ID + '"month="' + full.DATA_DATE + '"packbar="' + full.PACK_BAR + '" ccomid="' + full.CCOM_ID + '" class="handCursor order-detail">'+data+'</span>'
			},
			targets: 5
		}, {
			// 特殊客户
			className:'digit-center',
			data: 'TYPE',
			targets: 6
		}, /*{
			// 操作
			className:'digit-center',
			render: function(data, type, full, meta) {
				return '<span custid="' + full.CUST_ID + '" class="handCursor apply">&nbsp;申请屏蔽 </span>'
			},
			targets: 6
		},*/
		{
			"orderable": false,
			"targets": [0, 1, 2, 3, 4, 6/*, 6*/]
		}/*,
		{
			"searchable": false,
			"targets": [6]
		}*/]

function format ( d ) {
	// `d` is the original data object for the row
	var returnhtml = '<table cellpadding="5" cellspacing="5" border="0" style="padding-left:50px;width:90%">'+
	'<thead>' +
		'<tr>' +
		'<th style="width:20%;"></th>' +
		'<th style="width:30%;"></th>' +
		'<th style="width:20%;"></th>' +
		'<th style="width:30%;"></th>' +
		'</tr>' +
	'</thead>' +
	'<tbody>' ;
	var returnhtml1 = ''
	var returnhtml2 = ''
	var returnhtml3 = ''
	var returnhtml4 = ''
	if( isNaN( d.QTY_SOLD1 ) ){
		returnhtml1 = '';
	}else{
		returnhtml1 = 
		'<tr>'+
			'<td>订货日期:</td>'+
			'<td>'+d.DATE11.substr(0, 4) + '年' + d.DATE11.substr(4, 2) + '月'+ d.DATE11.substr(6, 2) + '日'+'</td>'+
			'<td>订货量:</td>'+
			'<td>'+d.QTY_SOLD1+'</td>'+
		'</tr>';
	}
	if( isNaN( d.QTY_SOLD2 ) ){
		returnhtml2 = '';
	}else{
		returnhtml2 = 
		'<tr>'+
			'<td>订货日期:</td>'+
			'<td>'+d.DATE12.substr(0, 4) + '年' + d.DATE12.substr(4, 2) + '月'+ d.DATE12.substr(6, 2) + '日'+'</td>'+
			'<td>订货量:</td>'+
			'<td>'+d.QTY_SOLD2+'</td>'+
		'</tr>';
	}
	
	if( isNaN( d.QTY_SOLD3 ) ){
		returnhtml3 = '';
	}else{
		returnhtml3 = 
		'<tr>'+
			'<td>订货日期:</td>'+
			'<td>'+d.DATE13.substr(0, 4) + '年' + d.DATE13.substr(4, 2) + '月'+ d.DATE13.substr(6, 2) + '日'+'</td>'+
			'<td>订货量:</td>'+
			'<td>'+d.QTY_SOLD3+'</td>'+
		'</tr>';
	}
	if( isNaN( d.QTY_SOLD4 ) ){
		returnhtml4 = '';
	}else{
		returnhtml4 = 
		'<tr>'+
			'<td>订货日期:</td>'+
			'<td>'+d.DATE14.substr(0, 4) + '年' + d.DATE14.substr(4, 2) + '月'+ d.DATE14.substr(6, 2) + '日'+'</td>'+
			'<td>订货量:</td>'+
			'<td>'+d.QTY_SOLD4+'</td>'+
		'</tr>';
	}
	returnhtml = returnhtml + returnhtml1 + returnhtml2 + returnhtml3 + returnhtml4 + '</table></tbody>';
	return returnhtml;
}

exports.init = function( ccomId, packbar, month ) {
	$('#detail-cont').html(tbody)
	var tableHeigth = Math.max($(document).height() - 560, 371)
	 
	var _table = $('#cust-table').on( 'processing.dt', function ( e, settings, processing ) { 			
			if( processing ){ 				
				$('#detail-cont').scmrLoading() 			
			}else{ 				
				$('#detail-cont').unScmrLoading() 			
			}
		}).DataTable({
		ajax:{
			url: 'dealorderconalarm.cmd?method=getCustInfo',
			type: 'POST',
			data: function(d) {
				d.month = month,
				d.packbar = packbar,
				d.comId = ccomId
			}
		},
		buttons:[
			{
				extend:'excel',
				title:'订货集中度预警 零售户情况',
				exportOptions: {
					columns:[0, 1, 2, 3, 4, 5, 6]
				}
			}
		],
		columnDefs: columnDefs,
		paging: false,
		scrollY: tableHeigth + 'px',
		order: [[5, 'desc']]
	})
	//当表格排序或者搜索时，更新“序号”值
	_table.on( 'order.dt search.dt', function () {
		_table.column(0, {search:'applied', order:'applied'}).nodes().each( function (cell, i) {
			cell.innerHTML = i+1;
		} );
	} ).draw();	
		
	$('#search-btn').on('click', function() {
		$('#detail-cont').hide();
	})

	$('#detail-cont').on('click', '.order-detail', function(e) {
		var tr = $(this).closest('tr');
		var row = _table.row( tr );
		if ( row.child.isShown() ) {
			// This row is already open - close it
			row.child.hide();
			tr.removeClass('shown');
		}
		else {
			// Open this row
			row.child( format(row.data()) ).show();
			tr.addClass('shown');
		}
	})
	
	$('#detail-cont').on('click', '.apply', function(e) {
		var ccomId = $(this).attr('ccomId')
		var month = $(this).attr('month')
		var packbar = $(this).attr('packbar')
		var custId = $(this).attr('custid')
		
		
		
	})
}
