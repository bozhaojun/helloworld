var $ = require('jquery')
var CustTable = require('./table-cust')

var tbodySalesman =
	'<table class="table table-striped table-bordered table-hover dataTable" id="alarm-table" >' +
		'<thead>' +
			'<tr>' +
				'<th style="width:3%;">序号</th>' +
				'<th style="width:5%;">省份</th>' +
				'<th style="width:5%;">地市</th>' +
				'<th style="width:8%;">时间</th>' +
				'<th style="width:10%;">品牌(规格)</th>' +
				'<th style="width:7%;">前5个零售户<br>销量占比</th>' +
				'<th style="width:7%;">负责人</th>' +
			'</tr>' +
		'</thead>' +
		'<tbody></tbody>' +
	'</table>'

var tbodyCenter =
	'<table class="table table-striped table-bordered table-hover dataTable" id="alarm-table" >' +
		'<thead>' +
			'<tr>' +
				'<th style="width:3%;">序号</th>' +
				'<th style="width:5%;">省份</th>' +
				'<th style="width:5%;">地市</th>' +
				'<th style="width:8%;">时间</th>' +
				'<th style="width:10%;">品牌(规格)</th>' +
				'<th style="width:7%;">前5个零售户<br>销量占比</th>' +
				'<th style="width:7%;">负责人</th>' +
				'<th style="width:4%;">操作</th>' +
			'</tr>' +
		'</thead>' +
		'<tbody></tbody>' +
	'</table>'
				
var columnDefs = [
		{
			className:'digit-center',
			searchable: false,
			orderable: false,
			targets: 0
		}, {
			// 省份
			data: 'PCOM_NAME',
			targets: 1
		}, {
			// 地市
			data: 'CCOM_NAME',
			targets: 2,
		}, {
			// 时间
			className:'digit-center',
			data: 'DATA_DATE',
			render: function(data, type, full, meta) {
				return data.substr(0, 4) + '年' + data.substr(4, 2) + '月'
			},
			targets: 3
		},{
			// 品牌(规格)
			data: 'ITEM_NAME',
			targets: 4
		}, {
			// 销量占比
			className:'digit-center',
			data: 'CON_RATIO',
			render: function(data, type, full, meta) {
				return '<span month="' + full.DATA_DATE + '"packbar="' + full.PACK_BAR + '" ccomid="' + full.CCOM_ID + '" class="handCursor con-ratio">' + data+ '%</span>'
			},
			targets: 5
		}, {
			// 负责人
			className:'digit-center',
			data: 'IN_CHARGE',
			targets: 6
		},
		{
			"orderable": false,
			"targets": [0, 1, 2, 3, 4, 6]
		}
	]
var columnDefCenter = [
	 {
		// 指派
		className:'digit-center',
		render: function(data, type, full, meta) {
			return '<span alarmid="' + full.ALARM_NUM + '" class="handCursor assign">指派</span>'
		},
		targets: 7
	}
]
exports.init = function( param ) {
	if ( param ){
		$('#table-cont').html( tbodyCenter )
		columnDefs.push( columnDefCenter[0] )
	} else {
		$('#table-cont').html( tbodySalesman )
	}
	var tableHeigth = Math.max($(document).height() - 560, 371)
	var _table = $('#alarm-table').on( 'processing.dt', function ( e, settings, processing ) { 			
			if( processing ){ 				
				$('#table-cont').scmrLoading() 			
			}else{ 				
				$('#table-cont').unScmrLoading() 			
			}
		}).DataTable({
		ajax:{
			url: 'dealorderconalarm.cmd?method=getAlarmInfo',
			type: 'POST',
			data: function(d) {
				d.monthId = $('#month-id').val(),
				d.comId = $('#com_idSearch').val(),
				d.packBar = $('#pack_barSearch').val()
			}
		},
		buttons:[
			{
				extend:'excel',
				title:'订货集中度预警',
				exportOptions: {
					columns:[0, 1, 2, 3, 4, 5]
				}
			}
		],
		columnDefs: columnDefs,
		paging: false,
		scrollY: tableHeigth + 'px',
		order: [[5, 'desc']]
	})
	//当表格排序或者搜索时，更新“序号”值
	_table.on( 'order.dt search.dt', function () {
		_table.column(0, {search:'applied', order:'applied'}).nodes().each( function (cell, i) {
			cell.innerHTML = i+1;
		} );
	} ).draw();
		
	$('#search-btn').on('click', function() {
		_table.ajax.reload()
	})

	$('#table-cont').on('click', '.con-ratio', function(e) {
		$('#custList').show();
		var ccomId = $(this).attr('ccomId')
		var month = $(this).attr('month')
		var packbar = $(this).attr('packbar')
		CustTable.init( ccomId, packbar, month );
	})
	
	$('#table-cont').on('click', '.assign', function(e) {
		var alarmId = $(this).attr("alarmid");
		var pcomName = $(this).parents("tr").children().eq(0).html()
		var ccomName = $(this).parents("tr").children().eq(1).html()
		var date1	 = $(this).parents("tr").children().eq(2).html()
		var itemName = $(this).parents("tr").children().eq(3).html()
		var conRatio = $(this).parents("tr").children().eq(4).text()
		var inCharge = $(this).parents("tr").children().eq(5).html()
		//数据来源是这个点击事件的span
		var diyHtml=
			'<form class="form-horizontal">'+
			'	<div class="form-group" style="width:680px;margin-top: 15px;">'+
			'	<label for="" class="col-sm-3 control-label" style="font-weight: bold;">省份：</label>'+
			'	<div class="col-sm-3">'+
			'		<p class="form-control-static">'+pcomName+'</p>'+
			'	</div>'+
			'	<label for="" class="col-sm-3 control-label" style="font-weight: bold;">地市：</label>'+
			'	<div class="col-sm-3">'+
			'	  <p class="form-control-static">'+ccomName+'</p>'+
			'	</div>'+
			'	</div>'+
			'	<div class="form-group" style="width:680px">'+
			'	<label for="" class="col-sm-3 control-label" style="font-weight: bold;">时间：</label>'+
			'	<div class="col-sm-3">'+
			'	  <p class="form-control-static">'+date1+'</p>'+
			'	</div>'+
			'	<label for="" class="col-sm-3 control-label" style="font-weight: bold;">品牌(规格)：</label>'+
			'	<div class="col-sm-3">'+
			'	  <p class="form-control-static">'+itemName+'</p>'+
			'	</div>'+
			'	</div>'+
			'	<div class="form-group" style="width:680px">'+
			'	<label for="" class="col-sm-3 control-label" style="font-weight: bold;">前5占比：</label>'+
			'	<div class="col-sm-3">'+
			'	  <p class="form-control-static">'+conRatio+'</p>'+
			'	</div>'+
			'	<label for="" class="col-sm-3 control-label" style="font-weight: bold;">负责人：</label>'+
			'	<div class="col-sm-3">'+
			'	  <p class="form-control-static">'+inCharge+'</p>'+
			'	</div>'+
			'	</div>'+
			'	<div class="form-group" style="width:680px">'+
			'	<label for="" class="col-sm-3 control-label" style="font-weight: bold;">处理人：</label>'+
			'		<div class="col-sm-3">'+
			'			<span class="col-sm-9" style="padding-left: 0px;padding-right: 4px;">'+
			'			<input class="form-control" size="16" type="text"  name="emp_nameSearch" id="emp_nameSearch" value="" autocomplete="off">'+
			'			</span>'+
			'			<span id="empTreeSpan" class="fa fa-caret-down imr-tree-span-icon"  style="padding-left: 5px;padding-right: 5px;"></span>'+
			'			<div id="empTree" class="ztree  imr-tree-content-emp"></div>'+
			'			<input type="hidden" name="emp_idSearch" id="emp_idSearch" value="" /> '+
			'		</div>'+
			'	</div>'+
			'	<div class="form-group" style="width:680px">'+
			'	<label for="" class="col-sm-3 control-label" style="font-weight: bold;">任务描述：</label>'+
			'	<div class="col-sm-9">'+
			'		<textarea class="form-control" id="task_describe" placeholder="任务描述" style="width:480px;height:130px;" maxlength="300"></textarea>'+
			'	</div>'+
			'	</div> '+
			'</form>'
		
		layer.open({
			type : 1,
			area : [ '730px', '500px' ],
			shadeClose: true,
			content: diyHtml,
			title : '预警处理任务指派',
			btn: ['确定', '关闭'],
			success: function(layero, index){
				initEmpTree({
					$treeId:$("#empTree"),
					$inputName: $('#emp_nameSearch'),
					$inputId: $('#emp_idSearch'),
					$treeSpan: $('#treeSpan'),
					treeId:"empTree",
					selType:"8",
					$otherTreeId:$("#itemTree")
				}); 
			},
			close : function( idx ){
				layer.close( idx )
			},
			yes:function( index, layero ){
				var emp_idSearch = layero.find('#emp_idSearch').val()
				var emp_nameSearch = layero.find('#emp_nameSearch').val()
				var task_describe = layero.find('#task_describe').val()
				if( emp_idSearch == '' || emp_idSearch == null ){
					layer.alert("请选择处理人。")
					return
				}
				$.ajax({
					data: { 
						"emp_idSearch": emp_idSearch, 
						"emp_nameSearch": emp_nameSearch,
						"task_describe": task_describe,
						"alarm_id": alarmId,
						"alarm_type": "01" 
					},
					type: 'post',
					dataType: 'josn',
					url: 'taskassign.cmd?method=saveAssign',
					complete: function (req) {
						if(JSON.parse(req.responseText).ok){
							layer.msg("指派成功。", {icon: 1})
							layer.close( index )
						}else{
							layer.msg("指派失败，请稍后重试。", {icon: 2})
							layer.close( index )
						}
					}
				});
			},
			btn2: function(){
				layer.closeAll();
			}
		})
	})
}
