var $ = require('jquery')
var CompTable = require('./table-comp')

var tbody =
	'<table class="table table-striped table-bordered table-hover dataTable" id="alarm-table" >' +
		'<thead>' +
			'<tr>' +
				'<th style="width:3%;">序号</th>' +
				'<th style="width:5%;">省份</th>' +
				'<th style="width:5%;">地市</th>' +
				'<th style="width:7%;">时间</th>' +
				'<th style="width:10%;">品牌(规格)</th>' +
				'<th style="width:7%;">波动情况</th>' +
				'<th style="width:7%;">竞品情况</th>' +
			'</tr>' +
		'</thead>' +
		'<tbody></tbody>' +
	'</table>'
				
var columnDefs = [
		{
			className:'digit-center',
			searchable: false,
			orderable: false,
			targets: 0
		}, {
			// 省份
			className:'digit-center',
			data: 'PCOM_NAME',
			targets: 1
		}, {
			// 地市
			className:'digit-center',
			data: 'CCOM_NAME',
			targets: 2,
		}, {
			// 时间
			data: 'DATA_DATE',
			render: function(data, type, full, meta) {
				return data.substr(0, 4) + '年' + data.substr(4, 2) + '月'
			},
			targets: 3
		},{
			// 品牌(规格)
			data: 'ITEM_NAME',
			targets: 4
		}, {
			// 波动情况
			className:'digit-center',
			data: 'RATE',
			render: function(data, type, full, meta) {
				return '<span month="' + full.DATA_DATE + '"packbar="' + full.PACK_BAR + '" ccomid="' + full.CCOM_ID + '" class="handCursor rate">' + data+ '%</span>'
			},
			targets: 5
		}, {
			// 竞品情况
			className:'digit-center',
			data: 'COMP_ABNORMAL',
			render: function(data, type, full, meta) {
				if( data == '1' ){
					return '异常'
				}else{
					return '正常'
				}
			},
			targets: 6
		},
		{
			"orderable": false,
			"targets": [0, 1, 2, 3, 4, 6]
		}
	]

exports.init = function() {
	$('#table-cont').html( tbody )
	var tableHeigth = Math.max($(document).height() - 560, 371)
	var _table = $('#alarm-table').on( 'processing.dt', function ( e, settings, processing ) { 			
			if( processing ){ 				
				$('#table-cont').scmrLoading() 			
			}else{ 				
				$('#table-cont').unScmrLoading() 			
			}
		}).DataTable({
		ajax:{
			url: 'dealitemorderwave.cmd?method=getAlarmInfo',
			type: 'POST',
			data: function(d) {
				d.monthId = $('#month-id').val(),
				d.comId = $('#com_idSearch').val(),
				d.packBar = $('#pack_barSearch').val()
			}
		},
		buttons:[
			{
				extend:'excel',
				title:'活跃零售户波动异常预警',
				exportOptions: {
					columns:[0, 1, 2, 3, 4, 5, 6]
				}
			}
		],
		columnDefs: columnDefs,
		paging: false,
		scrollY: tableHeigth + 'px',
		order: [[5, 'desc']]
	})
	
	//当表格排序或者搜索时，更新“序号”值
	_table.on( 'order.dt search.dt', function () {
		_table.column(0, {search:'applied', order:'applied'}).nodes().each( function (cell, i) {
			cell.innerHTML = i+1;
		} );
	} ).draw();
		
	$('#search-btn').on('click', function() {
		_table.ajax.reload()
	})

	$('#table-cont').on('click', '.rate', function(e) {
		$('#compList').show();
		var ccomId = $(this).attr('ccomId')
		var month = $(this).attr('month')
		var packbar = $(this).attr('packbar')
		CompTable.init( ccomId, packbar, month );
	})
	
}
